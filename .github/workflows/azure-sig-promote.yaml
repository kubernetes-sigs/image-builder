# Reusable workflow for promoting Azure SIG images to community gallery
#
# This workflow promotes a built image from the staging gallery to the
# community gallery for public access.
#
# Required secrets:
# - AZURE_CLIENT_ID - Azure service principal client ID
# - AZURE_TENANT_ID - Azure tenant ID
# - AZURE_SUBSCRIPTION_ID - Azure subscription ID
#
# Required environment variables (set in GitHub repository or organization settings):
# - EULA_LINK - the URL to the EULA for the image
# - PUBLISHER_EMAIL - the email for the image publisher
# - PUBLISHER_URI - the URI for the image publisher
# - SIG_PUBLISHER - the publisher for the image definition

name: Promote Azure SIG Image

on:
  workflow_call:
    inputs:
      publishing_info:
        description: 'JSON object containing image publishing information'
        required: true
        type: string
      resource_group:
        description: 'Azure resource group name'
        required: false
        type: string
        default: 'cluster-api-gallery'
      gallery_name:
        description: 'Community gallery name'
        required: false
        type: string
        default: 'community_gallery'
      replicated_regions:
        description: 'Regions to replicate the image to (space-separated)'
        required: false
        type: string
        default: ''
      public_name_prefix:
        description: 'Prefix for the community gallery name'
        required: false
        type: string
        default: 'ClusterAPI'
      sig_offer:
        description: 'Offer name for image definitions'
        required: false
        type: string
        default: 'reference-images'
      gallery_description:
        description: 'Description for the image gallery'
        required: false
        type: string
        default: 'Shared image gallery for Cluster API Provider Azure'

permissions:
  id-token: write
  contents: read

jobs:
  approve_promotion:
    name: Approve Image Promotion
    runs-on: ubuntu-latest
    environment: image-promotion-approval
    steps:
      - name: Promotion Approved
        run: echo "Image promotion approved"

  publish_to_sig:
    name: Publish to Community Gallery
    needs: approve_promotion
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      RESOURCE_GROUP: ${{ inputs.resource_group }}
      GALLERY_NAME: ${{ inputs.gallery_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download publishing info artifact
        uses: actions/download-artifact@v4
        with:
          name: publishing-info
          path: images/capi/packer/azure/sig/

      - name: Import variables from build
        id: vars
        run: |
          set -euo pipefail

          PUBLISHING_INFO='${{ inputs.publishing_info }}'

          echo "DISTRO=$(echo $PUBLISHING_INFO | jq -r .distro)" >> $GITHUB_OUTPUT
          echo "HYPERV_GEN=$(echo $PUBLISHING_INFO | jq -r .hyperv_gen)" >> $GITHUB_OUTPUT
          echo "OS_TYPE=$(echo $PUBLISHING_INFO | jq -r .os_type)" >> $GITHUB_OUTPUT
          echo "MANAGED_IMAGE_RESOURCE_GROUP_NAME=$(echo $PUBLISHING_INFO | jq -r .managed_image_resource_group_name)" >> $GITHUB_OUTPUT
          echo "MANAGED_IMAGE_NAME=$(echo $PUBLISHING_INFO | jq -r .managed_image_name)" >> $GITHUB_OUTPUT
          echo "MANAGED_IMAGE_ID=$(echo $PUBLISHING_INFO | jq -r .managed_image_id)" >> $GITHUB_OUTPUT
          echo "MANAGED_IMAGE_LOCATION=$(echo $PUBLISHING_INFO | jq -r .managed_image_location)" >> $GITHUB_OUTPUT
          echo "MANAGED_IMAGE_SHARED_IMAGE_GALLERY_ID=$(echo $PUBLISHING_INFO | jq -r .managed_image_shared_image_gallery_id)" >> $GITHUB_OUTPUT
          echo "SHARED_IMAGE_GALLERY_RESOURCE_GROUP=$(echo $PUBLISHING_INFO | jq -r .shared_image_gallery_resource_group)" >> $GITHUB_OUTPUT
          echo "SHARED_IMAGE_GALLERY_NAME=$(echo $PUBLISHING_INFO | jq -r .shared_image_gallery_name)" >> $GITHUB_OUTPUT
          echo "SHARED_IMAGE_GALLERY_IMAGE_NAME=$(echo $PUBLISHING_INFO | jq -r .shared_image_gallery_image_name)" >> $GITHUB_OUTPUT
          echo "SHARED_IMAGE_GALLERY_IMAGE_VERSION=$(echo $PUBLISHING_INFO | jq -r .shared_image_gallery_image_version)" >> $GITHUB_OUTPUT
          echo "TAGS=$(echo $PUBLISHING_INFO | jq -r .tags)" >> $GITHUB_OUTPUT

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Publish to community gallery
        working-directory: images/capi
        env:
          DISTRO: ${{ steps.vars.outputs.DISTRO }}
          HYPERV_GEN: ${{ steps.vars.outputs.HYPERV_GEN }}
          OS_TYPE: ${{ steps.vars.outputs.OS_TYPE }}
          MANAGED_IMAGE_ID: ${{ steps.vars.outputs.MANAGED_IMAGE_ID }}
          MANAGED_IMAGE_LOCATION: ${{ steps.vars.outputs.MANAGED_IMAGE_LOCATION }}
          SHARED_IMAGE_GALLERY_IMAGE_NAME: ${{ steps.vars.outputs.SHARED_IMAGE_GALLERY_IMAGE_NAME }}
          SHARED_IMAGE_GALLERY_IMAGE_VERSION: ${{ steps.vars.outputs.SHARED_IMAGE_GALLERY_IMAGE_VERSION }}
          TAGS: ${{ steps.vars.outputs.TAGS }}
          EULA_LINK: ${{ vars.EULA_LINK }}
          PUBLISHER_EMAIL: ${{ vars.PUBLISHER_EMAIL }}
          PUBLISHER_URI: ${{ vars.PUBLISHER_URI }}
          SIG_PUBLISHER: ${{ vars.SIG_PUBLISHER }}
        run: |
          set -euo pipefail

          EOL_DATE=$(date --date='+6 months' +"%Y-%m-%dT00:00:00+00:00")
          GALLERY_DESCRIPTION="${{ inputs.gallery_description }}"
          GALLERY_NAME="${{ inputs.gallery_name }}"
          PUBLIC_NAME_PREFIX="${{ inputs.public_name_prefix }}"
          RESOURCE_GROUP="${{ inputs.resource_group }}"
          SIG_OFFER="${{ inputs.sig_offer }}"

          # Set replicated regions, defaulting to a standard set if not specified
          if [[ -n "${{ inputs.replicated_regions }}" ]]; then
            REPLICATED_REGIONS="${{ inputs.replicated_regions }}"
          else
            REPLICATED_REGIONS="${MANAGED_IMAGE_LOCATION} australiaeast canadacentral eastus eastus2 eastus2euap francecentral germanywestcentral northeurope switzerlandnorth uksouth westeurope"
          fi

          # Create the resource group if needed
          if ! az group show -n ${RESOURCE_GROUP} -o none 2>/dev/null; then
            az group create -n ${RESOURCE_GROUP} -l ${MANAGED_IMAGE_LOCATION} --tags ${TAGS:-}
          fi

          # Create the public community shared image gallery if it doesn't exist
          if ! az sig show --gallery-name ${GALLERY_NAME} --resource-group ${RESOURCE_GROUP} -o none 2>/dev/null; then
            az sig create \
              --gallery-name ${GALLERY_NAME} \
              --resource-group ${RESOURCE_GROUP} \
              --description "${GALLERY_DESCRIPTION}" \
              --eula "${EULA_LINK}" \
              --location ${MANAGED_IMAGE_LOCATION} \
              --public-name-prefix ${PUBLIC_NAME_PREFIX} \
              --publisher-email "${PUBLISHER_EMAIL}" \
              --publisher-uri "${PUBLISHER_URI}" \
              --tags ${TAGS} \
              --permissions Community
          fi

          # Translate prohibited words to alternatives in the image definition name
          GALLERY_IMAGE_DEFINITION=${SHARED_IMAGE_GALLERY_IMAGE_NAME//ubuntu/ubun2}
          GALLERY_IMAGE_DEFINITION=${GALLERY_IMAGE_DEFINITION//windows/win}

          # Create image definition if it doesn't exist
          if ! az sig image-definition show --gallery-name ${GALLERY_NAME} --gallery-image-definition ${GALLERY_IMAGE_DEFINITION} --resource-group ${RESOURCE_GROUP} -o none 2>/dev/null; then
            az sig image-definition create \
              --resource-group ${RESOURCE_GROUP} \
              --gallery-name ${GALLERY_NAME} \
              --gallery-image-definition ${GALLERY_IMAGE_DEFINITION} \
              --publisher ${SIG_PUBLISHER} \
              --offer ${SIG_OFFER} \
              --sku ${DISTRO} \
              --hyper-v-generation ${HYPERV_GEN} \
              --os-type ${OS_TYPE} \
              | tee -a sig-publishing.json
          fi

          # Delete the image version if it exists (always create a new image, overwriting if necessary)
          if az sig image-version show --gallery-name ${GALLERY_NAME} --gallery-image-definition ${GALLERY_IMAGE_DEFINITION} --gallery-image-version ${SHARED_IMAGE_GALLERY_IMAGE_VERSION} --resource-group ${RESOURCE_GROUP} -o none 2>/dev/null; then
            az sig image-version delete \
              --resource-group ${RESOURCE_GROUP} \
              --gallery-name ${GALLERY_NAME} \
              --gallery-image-definition ${GALLERY_IMAGE_DEFINITION} \
              --gallery-image-version ${SHARED_IMAGE_GALLERY_IMAGE_VERSION}
          fi

          # Copy the tags from the managed image to the image version
          IMAGE_TAGS=$(az tag list --resource-id ${MANAGED_IMAGE_ID} | jq -r '.properties.tags | to_entries | map("\(.key)=\(.value)") | join(" ")')

          # Create the image version
          az sig image-version create \
            --resource-group ${RESOURCE_GROUP} \
            --gallery-name ${GALLERY_NAME} \
            --gallery-image-definition ${GALLERY_IMAGE_DEFINITION} \
            --gallery-image-version ${SHARED_IMAGE_GALLERY_IMAGE_VERSION} \
            --target-regions ${REPLICATED_REGIONS} \
            --managed-image "${MANAGED_IMAGE_ID}" \
            --end-of-life-date ${EOL_DATE} \
            --tags ${IMAGE_TAGS} \
            | tee -a sig-publishing.json

      - name: Upload publishing artifact
        uses: actions/upload-artifact@v4
        with:
          name: sig-publishing
          path: images/capi/sig-publishing.json
          retention-days: 30
