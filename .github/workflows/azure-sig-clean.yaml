# Reusable workflow for cleaning up Azure SIG staging resources
#
# This workflow cleans up the staging managed image and image version
# after the image has been promoted to the community gallery.

name: Clean Azure SIG Staging Resources

on:
  workflow_call:
    inputs:
      publishing_info:
        description: 'JSON object containing image publishing information'
        required: true
        type: string
      resource_group:
        description: 'Azure resource group name'
        required: false
        type: string
        default: 'cluster-api-gallery'
      staging_gallery_name:
        description: 'Staging gallery name'
        required: false
        type: string
        default: 'staging_gallery'

permissions:
  id-token: write
  contents: read

jobs:
  clean_sig:
    name: Clean Staging Resources
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      RESOURCE_GROUP: ${{ inputs.resource_group }}
      STAGING_GALLERY_NAME: ${{ inputs.staging_gallery_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download publishing info artifact
        uses: actions/download-artifact@v4
        with:
          name: publishing-info
          path: images/capi/packer/azure/sig/

      - name: Import variables from build
        id: vars
        run: |
          set -euo pipefail

          PUBLISHING_INFO='${{ inputs.publishing_info }}'

          echo "MANAGED_IMAGE_ID=$(echo $PUBLISHING_INFO | jq -r .managed_image_id)" >> $GITHUB_OUTPUT
          echo "SHARED_IMAGE_GALLERY_IMAGE_NAME=$(echo $PUBLISHING_INFO | jq -r .shared_image_gallery_image_name)" >> $GITHUB_OUTPUT
          echo "SHARED_IMAGE_GALLERY_IMAGE_VERSION=$(echo $PUBLISHING_INFO | jq -r .shared_image_gallery_image_version)" >> $GITHUB_OUTPUT

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Clean up staging resources
        working-directory: images/capi
        env:
          MANAGED_IMAGE_ID: ${{ steps.vars.outputs.MANAGED_IMAGE_ID }}
          SHARED_IMAGE_GALLERY_IMAGE_NAME: ${{ steps.vars.outputs.SHARED_IMAGE_GALLERY_IMAGE_NAME }}
          SHARED_IMAGE_GALLERY_IMAGE_VERSION: ${{ steps.vars.outputs.SHARED_IMAGE_GALLERY_IMAGE_VERSION }}
        run: |
          set -euo pipefail

          GALLERY_NAME="${STAGING_GALLERY_NAME:-staging_gallery}"
          RESOURCE_GROUP="${RESOURCE_GROUP:-cluster-api-gallery}"

          # Delete the source managed image if it exists
          if az image show --ids ${MANAGED_IMAGE_ID} -o none 2>/dev/null; then
            echo "Deleting managed image: ${MANAGED_IMAGE_ID}"
            az image delete --ids ${MANAGED_IMAGE_ID}
          else
            echo "Managed image not found, skipping deletion"
          fi

          # Delete the staging image version if it exists
          if az sig image-version show --resource-group ${RESOURCE_GROUP} --gallery-name ${GALLERY_NAME} --gallery-image-definition ${SHARED_IMAGE_GALLERY_IMAGE_NAME} --gallery-image-version ${SHARED_IMAGE_GALLERY_IMAGE_VERSION} -o none 2>/dev/null; then
            echo "Deleting staging image version: ${SHARED_IMAGE_GALLERY_IMAGE_VERSION}"
            az sig image-version delete \
              --resource-group ${RESOURCE_GROUP} \
              --gallery-name ${GALLERY_NAME} \
              --gallery-image-definition ${SHARED_IMAGE_GALLERY_IMAGE_NAME} \
              --gallery-image-version ${SHARED_IMAGE_GALLERY_IMAGE_VERSION}
          else
            echo "Staging image version not found, skipping deletion"
          fi
